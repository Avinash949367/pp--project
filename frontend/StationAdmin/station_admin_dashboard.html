<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Store Admin Dashboard - Park Pro</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    /* Custom teal theme matching register-spot.html */
    .sidebar-bg {
      background: linear-gradient(135deg, #f0fdfd 0%, #e0f2f1 100%);
      border-right: 1px solid #b2dfdb;
    }
    .sidebar-link {
      color: #1e3740;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 500;
      transition: all 0.3s ease;
      margin-bottom: 0.25rem;
    }
    .sidebar-link:hover {
      background-color: #46949d;
      color: white;
      transform: translateX(5px);
      box-shadow: 0 2px 8px rgba(70, 148, 157, 0.3);
    }
    .sidebar-link.active {
      background-color: #46949d;
      color: white;
      font-weight: 700;
      box-shadow: 0 2px 8px rgba(70, 148, 157, 0.4);
    }
    .sidebar-section-title {
      color: #46949d;
      font-weight: 700;
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
      padding-left: 1rem;
      text-transform: uppercase;
      font-size: 0.875rem;
      letter-spacing: 0.05em;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .sidebar-dropdown-menu {
      display: none;
      transition: all 0.3s ease;
      padding-left: 1rem;
    }
    .sidebar-dropdown-menu.show {
      display: block;
    }
    .stats-card {
      background: linear-gradient(135deg, white 0%, #f8fffe 100%);
      border-left: 4px solid #46949d;
      padding: 1.5rem;
      border-radius: 1rem;
      box-shadow: 0 4px 15px rgba(70, 148, 157, 0.15);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .stats-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(70, 148, 157, 0.25);
    }
    .stats-icon {
      font-size: 2rem;
      color: #46949d;
      margin-bottom: 0.5rem;
    }
    .main-content {
      background-color: #fafafa;
      min-height: 100vh;
    }
    .table-container {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }
    table th {
      background: linear-gradient(135deg, #e0f2f1 0%, #b2dfdb 100%);
      color: #1e3740;
      font-weight: 600;
      padding: 1rem;
      text-align: left;
    }
    table td {
      padding: 1rem;
      border-bottom: 1px solid #e0f2f1;
    }
    table tr:hover {
      background-color: #f0fdfd;
    }
    .notification-badge {
      background: #ff6b6b;
      color: white;
      border-radius: 50%;
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      font-weight: bold;
      margin-left: 0.5rem;
    }
    .profile-dropdown {
      position: relative;
    }
    .profile-dropdown .dropdown-menu {
      position: absolute;
      right: 0;
      top: 100%;
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      z-index: 1000;
      min-width: 200px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
    }
    .profile-dropdown .dropdown-menu.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
  </style>
</head>
<body class="bg-gray-50">
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 sidebar-bg flex flex-col py-6 px-4 shadow-lg">
      <div class="text-center mb-8">
        <h2 class="text-2xl font-bold text-[#46949d] flex items-center justify-center gap-2">
          <i class="fas fa-car"></i>
          PARK PRO
        </h2>
        <p class="text-sm text-gray-600 mt-1">Station Admin</p>
      </div>

      <!-- Dashboard - Direct Link -->
      <a href="station_admin_dashboard.html" class="sidebar-link active">
        <i class="fas fa-tachometer-alt"></i>
        <span>Dashboard</span>
      </a>

      <!-- Parking Management -->
      <div class="sidebar-section-title" onclick="toggleDropdown('parkingDropdown')">
        <span>Parking Management</span>
        <i class="fas fa-chevron-down transition-transform duration-300" id="parkingIcon"></i>
      </div>
      <div id="parkingDropdown" class="sidebar-dropdown-menu">
        <a href="station_management.html" class="sidebar-link">
          <i class="fas fa-building"></i>
          <span>Manage Station</span>
        </a>
        <a href="slot_management.html" class="sidebar-link">
          <i class="fas fa-calendar-check"></i>
          <span>Manage Slots & Bookings</span>
        </a>
        <a href="station_visualization.html" class="sidebar-link">
          <i class="fas fa-map-marked-alt"></i>
          <span>Live Parking Map</span>
        </a>
        <a href="station_view_slots.html" class="sidebar-link">
          <i class="fas fa-chart-bar"></i>
          <span>Occupancy History</span>
        </a>
      </div>

      <!-- Payments & Billing -->
      <div class="sidebar-section-title" onclick="toggleDropdown('paymentsDropdown')">
        <span>Payments & Billing</span>
        <i class="fas fa-chevron-down transition-transform duration-300" id="paymentsIcon"></i>
      </div>
      <div id="paymentsDropdown" class="sidebar-dropdown-menu">
        <a href="slot_earning.html" class="sidebar-link">
          <i class="fas fa-money-bill-wave"></i>
          <span>Payment Dashboard</span>
        </a>
        <a href="#" class="sidebar-link" title="Coming Soon">
          <i class="fas fa-credit-card"></i>
          <span>Tariff Management</span>
        </a>
        <a href="#" class="sidebar-link" title="Coming Soon">
          <i class="fas fa-file-invoice"></i>
          <span>Invoices & Receipts</span>
        </a>
        <a href="#" class="sidebar-link" title="Coming Soon">
          <i class="fas fa-ticket-alt"></i>
          <span>Subscriptions / Passes</span>
        </a>
      </div>

      <!-- Security & Alerts -->
      <div class="sidebar-section-title" onclick="toggleDropdown('securityDropdown')">
        <span>Security & Alerts</span>
        <i class="fas fa-chevron-down transition-transform duration-300" id="securityIcon"></i>
      </div>
      <div id="securityDropdown" class="sidebar-dropdown-menu">
        <a href="#" class="sidebar-link" title="Coming Soon">
          <i class="fas fa-video"></i>
          <span>CCTV Integration</span>
        </a>
        <a href="#" class="sidebar-link" title="Coming Soon">
          <i class="fas fa-exclamation-triangle"></i>
          <span>Alerts & Violations</span>
        </a>
        <a href="#" class="sidebar-link" title="Coming Soon">
          <i class="fas fa-siren"></i>
          <span>Emergency Controls</span>
        </a>
      </div>

      <!-- Staff & Operations -->
      <div class="sidebar-section-title" onclick="toggleDropdown('staffDropdown')">
        <span>Staff & Operations</span>
        <i class="fas fa-chevron-down transition-transform duration-300" id="staffIcon"></i>
      </div>
      <div id="staffDropdown" class="sidebar-dropdown-menu">
        <a href="#" class="sidebar-link" title="Coming Soon">
          <i class="fas fa-user-tie"></i>
          <span>Staff Management</span>
        </a>
        <a href="#" class="sidebar-link" title="Coming Soon">
          <i class="fas fa-tasks"></i>
          <span>Tasks & Checklists</span>
        </a>
        <a href="#" class="sidebar-link" title="Coming Soon">
          <i class="fas fa-headset"></i>
          <span>Support Requests</span>
        </a>
      </div>

      <!-- Reports & Analytics -->
      <div class="sidebar-section-title" onclick="toggleDropdown('reportsDropdown')">
        <span>Reports & Analytics</span>
        <i class="fas fa-chevron-down transition-transform duration-300" id="reportsIcon"></i>
      </div>
      <div id="reportsDropdown" class="sidebar-dropdown-menu">
        <a href="#" class="sidebar-link" title="Coming Soon">
          <i class="fas fa-chart-line"></i>
          <span>Reports</span>
        </a>
        <a href="#" class="sidebar-link" title="Coming Soon">
          <i class="fas fa-clock"></i>
          <span>Peak Hours Analysis</span>
        </a>
        <a href="#" class="sidebar-link" title="Coming Soon">
          <i class="fas fa-users-cog"></i>
          <span>Customer Insights</span>
        </a>
      </div>

      <!-- Settings -->
      <div class="sidebar-section-title" onclick="toggleDropdown('settingsDropdown')">
        <span>Settings</span>
        <i class="fas fa-chevron-down transition-transform duration-300" id="settingsIcon"></i>
      </div>
      <div id="settingsDropdown" class="sidebar-dropdown-menu">
        <a href="station_settings.html" class="sidebar-link">
          <i class="fas fa-cog"></i>
          <span>Station Settings</span>
        </a>
        <a href="#" class="sidebar-link" title="Coming Soon">
          <i class="fas fa-lock"></i>
          <span>Access Control</span>
        </a>
        <a href="#" class="sidebar-link" title="Coming Soon">
          <i class="fas fa-desktop"></i>
          <span>System Configuration</span>
        </a>
        <a href="#" class="sidebar-link" title="Coming Soon">
          <i class="fas fa-palette"></i>
          <span>Theme & Preferences</span>
        </a>
      </div>

      <!-- Help & Support -->
      <div class="sidebar-section-title" onclick="toggleDropdown('helpDropdown')">
        <span>Help & Support</span>
        <i class="fas fa-chevron-down transition-transform duration-300" id="helpIcon"></i>
      </div>
      <div id="helpDropdown" class="sidebar-dropdown-menu">
        <a href="faq.html" class="sidebar-link">
          <i class="fas fa-question-circle"></i>
          <span>FAQ / Guides</span>
        </a>
        <a href="#" class="sidebar-link" title="Coming Soon">
          <i class="fas fa-ticket"></i>
          <span>Raise a Ticket</span>
        </a>
        <a href="contactus.html" class="sidebar-link">
          <i class="fas fa-phone"></i>
          <span>Contact Support</span>
        </a>
      </div>

      <!-- Logout -->
      <a href="station_adminlogin.html" class="sidebar-link mt-8 text-red-600 hover:bg-red-100 hover:text-red-700 border border-red-200">
        <i class="fas fa-sign-out-alt"></i>
        <span>Logout</span>
      </a>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 main-content p-6">
      <!-- Top bar -->
      <div class="flex justify-between items-center mb-8">
        <div>
          <h1 class="text-3xl font-bold text-[#1e3740]">Welcome back, Store Admin</h1>
          <p class="text-gray-600 mt-1">Here's what's happening with your parking station today.</p>
        </div>
        <div class="flex items-center space-x-4">
          <div class="relative">
            <i class="fas fa-bell text-[#46949d] text-xl cursor-pointer"></i>
            <span class="notification-badge">3</span>
          </div>
          <div class="profile-dropdown">
            <img id="profileImage" src="https://via.placeholder.com/40" alt="Profile" class="rounded-full w-10 h-10 cursor-pointer border-2 border-[#46949d]" />
            <div id="dropdownMenu" class="dropdown-menu">
              <div class="p-4 border-b border-gray-200">
                <p id="profileName" class="font-semibold text-gray-800">Admin User</p>
                <p id="profileEmail" class="text-sm text-gray-600">admin@parkpro.com</p>
              </div>
              <ul class="text-sm text-gray-700">
                <li>
                  <a href="adminprofile.html" class="flex items-center px-4 py-3 hover:bg-[#46949d] hover:text-white rounded transition-colors duration-150">
                    <i class="fas fa-user mr-3"></i>
                    Profile
                  </a>
                </li>
                <li>
                  <a href="station_adminlogin.html" id="signOutLink" class="flex items-center px-4 py-3 hover:bg-[#46949d] hover:text-white rounded transition-colors duration-150">
                    <i class="fas fa-sign-out-alt mr-3"></i>
                    Sign Out
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>

      <!-- Stats cards -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="stats-card">
          <div class="stats-icon">
            <i class="fas fa-parking"></i>
          </div>
          <h3 class="text-gray-600 text-sm font-medium">Total Slots</h3>
          <p class="text-3xl font-bold text-[#1e3740] mt-2">50</p>
          <p class="text-green-600 text-sm mt-1">
            <i class="fas fa-arrow-up"></i> +2 from yesterday
          </p>
        </div>
        <div class="stats-card">
          <div class="stats-icon">
            <i class="fas fa-calendar-check"></i>
          </div>
          <h3 class="text-gray-600 text-sm font-medium">Slots Booked Today</h3>
          <p class="text-3xl font-bold text-[#1e3740] mt-2">15</p>
          <p class="text-blue-600 text-sm mt-1">
            <i class="fas fa-clock"></i> 30% occupancy
          </p>
        </div>
        <div class="stats-card">
          <div class="stats-icon">
            <i class="fas fa-rupee-sign"></i>
          </div>
          <h3 class="text-gray-600 text-sm font-medium">Revenue Today</h3>
          <p class="text-3xl font-bold text-[#1e3740] mt-2">₹750</p>
          <p class="text-green-600 text-sm mt-1">
            <i class="fas fa-arrow-up"></i> +12% from yesterday
          </p>
        </div>
        <div class="stats-card">
          <div class="stats-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          <h3 class="text-gray-600 text-sm font-medium">Total Earnings</h3>
          <p class="text-3xl font-bold text-[#1e3740] mt-2">₹1,20,000</p>
          <p class="text-green-600 text-sm mt-1">
            <i class="fas fa-arrow-up"></i> +8% this month
          </p>
        </div>
      </div>

      <!-- Recent Bookings Table -->
      <div class="table-container">
        <div class="p-6 border-b border-gray-200">
          <h2 class="text-xl font-semibold text-[#1e3740] flex items-center">
            <i class="fas fa-calendar-alt mr-3 text-[#46949d]"></i>
            Recent Bookings
          </h2>
          <p class="text-gray-600 mt-1">Latest parking reservations and transactions</p>
        </div>
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead>
              <tr>
                <th>Booking ID</th>
                <th>User Name</th>
                <th>Vehicle</th>
                <th>Slot No</th>
                <th>Time</th>
                <th>Duration</th>
                <th>Amount</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="font-medium">#BK00123</td>
                <td>John Doe</td>
                <td>MH12 AB 1234</td>
                <td>A12</td>
                <td>09:30 AM</td>
                <td>2 hours</td>
                <td class="font-semibold text-green-600">₹100</td>
                <td>
                  <span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs font-medium">
                    Completed
                  </span>
                </td>
              </tr>
              <tr>
                <td class="font-medium">#BK00124</td>
                <td>Ayesha Khan</td>
                <td>KA01 CD 5678</td>
                <td>A15</td>
                <td>10:00 AM</td>
                <td>3 hours</td>
                <td class="font-semibold text-green-600">₹150</td>
                <td>
                  <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                    Active
                  </span>
                </td>
              </tr>
              <tr>
                <td class="font-medium">#BK00125</td>
                <td>Vikram Rao</td>
                <td>TN09 EF 9012</td>
                <td>A10</td>
                <td>10:45 AM</td>
                <td>1 hour</td>
                <td class="font-semibold text-green-600">₹50</td>
                <td>
                  <span class="px-2 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium">
                    Pending
                  </span>
                </td>
              </tr>
              <tr>
                <td class="font-medium">#BK00126</td>
                <td>Priya Sharma</td>
                <td>DL01 GH 3456</td>
                <td>B05</td>
                <td>11:15 AM</td>
                <td>4 hours</td>
                <td class="font-semibold text-green-600">₹200</td>
                <td>
                  <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs font-medium">
                    Active
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="p-4 border-t border-gray-200 text-center">
          <a href="slot_management.html" class="text-[#46949d] hover:text-[#2e7d7d] font-medium">
            View All Bookings <i class="fas fa-arrow-right ml-1"></i>
          </a>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Check if user is logged in on page load
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user'));

      if (!token || !user || user.role !== 'store admin') {
        window.location.href = 'station_adminlogin.html';
        return;
      }

      const profileImage = document.getElementById('profileImage');
      const profileName = document.getElementById('profileName');
      const profileEmail = document.getElementById('profileEmail');
      const dropdownMenu = document.getElementById('dropdownMenu');
      const signOutLink = document.getElementById('signOutLink');

      if (user) {
        if (user.profileImageUrl) {
          profileImage.src = user.profileImageUrl;
        } else if (user.name) {
          const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
          const canvas = document.createElement('canvas');
          canvas.width = 40;
          canvas.height = 40;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = '#46949d';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.font = '20px Arial';
          ctx.fillStyle = 'white';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(initials, canvas.width / 2, canvas.height / 2);
          profileImage.src = canvas.toDataURL();
        }
        if (user.name) {
          profileName.textContent = user.name;
        }
        if (user.email) {
          profileEmail.textContent = user.email;
        }
      }

      // Profile dropdown toggle
      profileImage.addEventListener('click', (e) => {
        e.stopPropagation();
        dropdownMenu.classList.toggle('show');
      });

      document.addEventListener('click', () => {
        dropdownMenu.classList.remove('show');
      });

      // Logout functionality
      signOutLink.addEventListener('click', (e) => {
        e.preventDefault();
        localStorage.clear();
        window.location.href = 'station_adminlogin.html';
      });

      // Sidebar dropdown toggle function
      window.toggleDropdown = function(id) {
        console.log('toggleDropdown called for:', id);
        const dropdown = document.getElementById(id);
        const icon = document.getElementById(id.replace('Dropdown', 'Icon'));

        if (dropdown.classList.contains('show')) {
          dropdown.classList.remove('show');
          icon.style.transform = 'rotate(0deg)';
        } else {
          dropdown.classList.add('show');
          icon.style.transform = 'rotate(180deg)';
        }
      };

      // Fetch and update dashboard stats and recent bookings
      async function fetchDashboardData() {
        try {
          console.log('User object from localStorage:', user);
          const stationId = user.stationId;
          console.log('Station ID retrieved:', stationId);

          if (!stationId) {
            console.error('Station ID not found in user object');
            alert('Station ID not found. Please login again.');
            return;
          }

          const headers = {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          };

          console.log('Fetching dashboard stats from:', `/api/slots/dashboard-stats/${stationId}`);

          // Fetch dashboard stats
          const statsResponse = await fetch(`http://localhost:5000/api/slots/dashboard-stats/${stationId}`, { headers });
          console.log('Stats response status:', statsResponse.status);

          if (!statsResponse.ok) {
            const errorText = await statsResponse.text();
            console.error('Stats response error:', errorText);
            throw new Error(`Failed to fetch dashboard stats: ${statsResponse.status} ${errorText}`);
          }
          const stats = await statsResponse.json();
          console.log('Stats data received:', stats);

          // Update stats cards
          document.querySelectorAll('.stats-card')[0].querySelector('p.text-3xl').textContent = stats.totalSlots || 0;
          document.querySelectorAll('.stats-card')[1].querySelector('p.text-3xl').textContent = stats.slotsBookedToday || 0;
          document.querySelectorAll('.stats-card')[2].querySelector('p.text-3xl').textContent = `₹${stats.revenueToday || 0}`;
          document.querySelectorAll('.stats-card')[3].querySelector('p.text-3xl').textContent = `₹${stats.totalEarnings || 0}`;

          console.log('Stats cards updated');

          console.log('Fetching recent bookings from:', `/api/slots/recent-bookings/${stationId}`);

          // Fetch recent bookings
          const bookingsResponse = await fetch(`http://localhost:5000/api/slots/recent-bookings/${stationId}`, { headers });
          console.log('Bookings response status:', bookingsResponse.status);

          if (!bookingsResponse.ok) {
            const errorText = await bookingsResponse.text();
            console.error('Bookings response error:', errorText);
            throw new Error(`Failed to fetch recent bookings: ${bookingsResponse.status} ${errorText}`);
          }
          const bookings = await bookingsResponse.json();
          console.log('Bookings data received:', bookings);

          // Update recent bookings table
          const tbody = document.querySelector('table tbody');
          tbody.innerHTML = ''; // Clear existing rows

          if (bookings.length === 0) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="8" class="text-center py-4 text-gray-500">No recent bookings found</td>';
            tbody.appendChild(tr);
          } else {
            bookings.forEach(booking => {
              const tr = document.createElement('tr');

              const statusColors = {
                active: 'bg-blue-100 text-blue-800',
                confirmed: 'bg-green-100 text-green-800',
                reserved: 'bg-yellow-100 text-yellow-800',
                cancelled: 'bg-red-100 text-red-800',
                expired: 'bg-gray-100 text-gray-800'
              };

              tr.innerHTML = `
                <td class="font-medium">#${booking.bookingId ? booking.bookingId.toString().slice(-6).toUpperCase() : 'N/A'}</td>
                <td>${booking.userName || 'Unknown'}</td>
                <td>${booking.vehicleNumber || 'Unknown'}</td>
                <td>${booking.slotNo || 'Unknown'}</td>
                <td>${booking.time || 'N/A'}</td>
                <td>${booking.duration || 'N/A'}</td>
                <td class="font-semibold text-green-600">₹${booking.amount || 0}</td>
                <td>
                  <span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[booking.status] || 'bg-gray-100 text-gray-800'}">
                    ${booking.status ? booking.status.charAt(0).toUpperCase() + booking.status.slice(1) : 'Unknown'}
                  </span>
                </td>
              `;
              tbody.appendChild(tr);
            });
          }

          console.log('Dashboard data fetch and update completed successfully');
        } catch (error) {
          console.error('Error fetching dashboard data:', error);
          alert('Failed to load dashboard data: ' + error.message);
        }
      }

      fetchDashboardData();

      // Update dashboard data every 30 seconds
      setInterval(fetchDashboardData, 30000);
    });
  </script>
</body>
</html>
